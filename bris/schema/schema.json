{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "resource:schema.json",
    "title": "Schema for bris inference configuration",
    "description": "This schema provides definitions for the bris-inference configuration files",
    "type": "object",
    "definitions": {
        "VerifOutput": {
            "description": "Verif-compatible Netcdf output file",
            "type": "object",
            "properties": {
                "verif": {
                    "type": "object",
                    "properties": {
                        "filename": {"type": "string"},
                        "variable": {"type": "string"},
                        "thresholds": {"type": "array", "items": {"type": "number"}},
                        "quantiles": {"type": "array", "items": {"type": "number", "minimum": 0, "maximum": 1}},
                        "obs_sources": {
                            "type": "array",
                            "items": {
                                "oneOf": [
                                    {"$ref": "#/definitions/VerifSource"},
                                    {"$ref": "#/definitions/FrostSource"}
                                ]
                            }
                        }
                    },
                    "required": ["filename", "variable", "obs_sources"]
                }
            },
            "required": ["verif"]
        },

        "NetcdfOutput": {
            "description": "Netcdf output file with MET Norway conventions",
            "type": "object",
            "properties": {
                "netcdf": {
                    "type": "object",
                    "properties": {
                        "filename_pattern": {
                            "description": "Where to write the output file. Time tokens allowed (e.g. %Y%m%d)",
                            "type": "string"
                        },
                        "variables": {
                            "description": "What variables to output? Leave empty to write all",
                            "type": "array",
                            "items": {"type": "string"}
                        }
                    },
                    "required": ["filename_pattern"]
                }
            },
            "required": ["netcdf"]
        },

        "VerifSource": {
            "description": "Observations stored in a Netcdf verif file",
            "type": "object",
            "properties": {
                "verif": {
                    "type": "object",
                    "properties": {
                        "filename": {
                            "description": "Where the file is located",
                            "type": "string"
                        }
                    },
                    "required": ["filename"]
                }
            },
            "required": ["verif"]
        },

        "FrostSource": {
            "type": "object",
            "properties": {
                "frost": {
                    "type": "object",
                    "properties": {},
                    "required": []
                }
            } ,
            "required": ["frost"]
        }
    },
    "properties": {
        "start_date": {
            "description": "First date to produce a forecast. E.g. 2023-11-24T12:00:00",
            "format": "date-time"
        },
        "end_date": {
            "description": "Last date to produce a forecast. E.g. 2023-11-24T12:00:00",
            "format": "date-time"
        },
        "frequency": {
            "description": "How often to make forecast runs? E.g. 6h",
            "type": "string"
        },
        "leadtimes": {
            "description": "What leadtimes should be provided in the output?",
            "type": "integer",
            "minimum": 1
        },
        "timestep": {
            "description": "What is the timestep between each leadtime? E.g. 6h",
            "type": "string"
        },
        "release_cache": {
            "description": "This option releases unused cached/memory used by torch",
            "type": "boolean"
        },
        "routing": {
            "type": "array",
            "items":  {
                "type": "object",
                "properties": {
                    "decoder_index": {"type": "integer", "minimum": 0},
                    "domain_index": {"type": "integer", "minimum": 0},
                    "outputs": {
                        "type": "array",
                        "items": {
                            "oneOf": [
                                {"$ref": "#/definitions/NetcdfOutput"},
                                {"$ref": "#/definitions/VerifOutput"}
                            ]
                        }
                    }
                }
            }
        }
    },
    "required": ["leadtimes", "frequency", "timestep", "release_cache"]
}
